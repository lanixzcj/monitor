{% extends 'base.html' %}
{% load staticfiles %}
{% block files %}
<script type="text/javascript">
$(document).ready(function () {
    $('#myModal').on('show.bs.modal', function(e) {
        var relatedTarget = $(e.relatedTarget)
        var currentTarget = $(e.currentTarget)
        var hostname = relatedTarget.data('hostname');

        src = 'safe_strategy/?h=' + hostname
        currentTarget.find('#myModalLabel').html(hostname + "安全策略");
        currentTarget.find('iframe#safeStrategyIframe').attr('src', src);
    })

    $(".modal iframe").on("load", function(){
        var bHeight = $(this)[0].contentWindow.document.body.scrollHeight;
        $(this).attr('height', bHeight);
    })

    $('#docDrawer').on('show.bs.drawer', function(e) {
        var relatedTarget = $(e.relatedTarget)
        var currentTarget = $(e.currentTarget)
        var hostname = relatedTarget.data('hostname');

        src = 'hostgraph/?h=' + hostname
        currentTarget.find('[name="hostname"]').html(hostname);
        currentTarget.find('iframe#graphIframe').attr('src', src);
    })

    $("form#trust_form").submit(function() {

        $this = $(this);
        console.log($this.serialize())
        $.ajax({
            type: $this.attr('method'),
            url: $this.attr('action'),
            data: $this.serialize(),
            success: function (response) {
                <!--TODO:mac地址正则表达式不严谨-->
                var ref = new RegExp("^([A-Fa-f0-9:]*)&(remove|add)&(unsafe|online|offline)$");
                var cap = response.match(ref);
                if (!cap)
                    return

                var tag_a = $('a[data-mac="'+cap[1]+'"]');

                if (cap[2] == 'remove') {
                    tag_a.html('从信任列表中移除');
                } else {
                    tag_a.html('加入信任列表中');
                }

                tag_a.data('method', cap[2]);

                var tag_stat = $('td.stat[data-mac="'+cap[1]+'"]');
                if (cap[3] == 'unsafe') {
                    tag_stat.html('危险');
                    tag_stat.attr('class', 'text-danger');
                } else if (cap[3] == 'online') {
                    tag_stat.html('在线中');
                    tag_stat.attr('class', 'text-success');
                } else {
                    tag_stat.html('离线');
                    tag_stat.attr('class', 'text-warning');
                }

                tag_stat.addClass('stat');
            }
        });

        return false;

    })

    $(".trust-submit").click(function() {
        var mac_address = $(this).data('mac');
        var method = $(this).data('method');

        var form = $("form#trust_form")
        $('input[name="mac_address"]').val(mac_address)
        $('input[name="method"]').val(method)

        $("form#trust_form").submit();
    })
});



</script>
<style type="text/css">
    .table th, .table td {
        text-align: center;
        vertical-align: middle!important;
    }
</style>

{% endblock %}
{% block main_content %}

<table class="table table-striped">
<thead>
    <tr>
        <td>ID/主机名</td>
        <td>监控</td>
        <td>状态</td>
        <td>IP地址</td>
        <td>MAC地址</td>
        <td>操作</td>
    </tr>
</thead>
    <tbody>
<form action="" role="form" name="form" id="trust_form" method="post"> {% csrf_token %}
    <input type="hidden" name="mac_address" value="">
    <input type="hidden" name="method" value="">
{% for mac_address, host in hosts %}
    <tr>
        <td>{{ host.hostname }}</td>
        <td>
            {% if host.hostname %}
                <a href="#docDrawer" data-show="drawer" href="#docDrawer" data-hostname="{{ host.hostname }}" aria-foldedopen="false"
                aria-controls="docDrawer">
                <img src="{% static 'images/figure.png' %}" width="20px" height="20px"></a></td>
            {% endif %}

        {% if host.stat == '1online' %}
            <td data-mac="{{ mac_address }}" class="text-success stat">在线中</td>
        {% elif host.stat == '2offline' %}
            <td data-mac="{{ mac_address }}" class="text-warning stat">离线</td>
        {% elif host.stat == '0unsafe' %}
            <td data-mac="{{ mac_address }}" class="text-danger stat">危险</td>
        {% endif %}
        <td>{{ host.ip }}</td>
        <td>{{ mac_address }}</td>
        <td>
            <div class="btn-group">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                更多 <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu">
                    {% if host.hostname %}
                    <li><a href="#" data-hostname="{{ host.hostname }}" data-toggle="modal" data-target="#myModal">配置安全策略</a></li>
                    {% endif %}
                    {% if host.is_trusted %}
                        <li><a href="#" class="trust-submit" data-method="remove"
                               data-mac="{{ mac_address }}">从信任列表中移除</a></li>
                    {% else %}
                        <li><a href="#" class="trust-submit" data-method="add"
                               data-mac="{{ mac_address }}">加入信任列表</a></li>

                    {% endif %}
                </ul>
            </div>
        </td>
    </tr>
{% endfor %}
</form>
    </tbody>
</table>

<div id="docDrawer" class="drawer drawer-right dw-xs-10 dw-sm-9 dw-md-8 fold in" aria-labelledby="docDrawer">
    <div class="drawer-heading">
        <button type="button" class="close" data-dismiss="drawer"><span aria-hidden="true">&times;</span><span
                class="sr-only">Close</span></button>
        <h2 class="drawer-title" name="hostname"></h2>
    </div>
    <div class="drawer-contents">

        <iframe id="graphIframe"
                src="" frameborder="0" scrolling="auto" width="100%" height="90%"></iframe>
    </div>
</div>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <h4 class="modal-title" id="myModalLabel"></h4>
            </div>
            <div class="modal-body" style="padding: 0">
                <iframe id="safeStrategyIframe"
                src="" frameborder="0" scrolling="no" width="100%" height="100%"></iframe>
            </div>
            <!--<div class="modal-footer">-->
                <!--<button type="button" class="btn btn-primary">Save changes</button>-->
            <!--</div>-->
        </div>
    </div>
</div>
{% endblock %}